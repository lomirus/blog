# 利用 Goroutine 优化求完美数的算法

初始创建于：***2020/12/29***

最后编辑于：***2020/12/31***

## 基础概念辨析

先把几个基础概念给弄明白。

### 核心（core）

> 1970年代以前，中央处理器（CPU）由多个独立单元构成，后来发展出由集成电路制造的中央处理器，这些高度收缩的组件就是所谓的微处理器，其中分出的中央处理器最为复杂的电路可以做成单一微小功能强大的单元，也就是所谓的核心。`$$^{[1]}`

核心数就是指的物理层面上 CPU 有几个核，个人感觉挺好理解的，没必要多讲。

### 线程（thread）(CPU)

一开始查线程这方面的资料时发现好多说法都不尽相同，后来才明白他们谈的线程原来不是同一个线程 ... 有的说的是 CPU 层面的，但更多人谈到进程时指的都是操作系统层面，不过这里为了确保文章内容的循序渐进，先只介绍硬件层面的。

> 线程数是一种逻辑的概念，简单地说，就是模拟出的CPU核心数。比如，可以通过一个CPU核心数模拟出2线程的CPU，也就是说，这个单核心的CPU被模拟成了一个类似双核心CPU的功能。我们从任务管理器的性能标签页中看到的是两个CPU。`$$^{[2]}`

![](threadcpu.png)

举个例子，上图所示的就是一个六核十二线程的 CPU (Ryzen 4600H)，它实际上只有六个核心，但通过超线程技术，它在每个核心上都提供了两个线程，而其中“逻辑处理器”也就即线程数的数量。

### 进程（process）

> 进程，是指计算机中已运行的程序。进程曾经是分时系统的基本运作单位。在面向进程设计的系统（如早期的UNIX，Linux 2.4及更早的版本）中，进程是程序的基本执行实体；在面向线程设计的系统（如当代多数操作系统、Linux 2.6及更新的版本）中，进程本身不是基本运行单位，而是线程的容器。`$$^{[3]}`

具体🌰放在等会儿一起举。

### 线程（thread）(OS)

> 线程是操作系统能够进行运算调度的最小单位。大部分情况下，它被包含在进程之中，是进程中的实际运作单位。一条线程指的是进程中一个单一顺序的控制流，一个进程中可以并发多个线程，每条线程并行执行不同的任务。`$$^{[4]}`

具体例子见下图：

![](process.png)

![](threados.png)


### 协程（coroutine） / Go协程（goroutine）

> 概念：指在后台中运行的轻量级执行线程，go 协程是 Go 中实现并发的关键组成部分 `$$^{[5]}`

emm，大体就这个意思...这种东西感觉还是直接用代码写出来比较好

### 其他（绿色线程、纤程）

查资料的时候还遇到了一些其他一些不太常用（或者说至少在这篇文章里不太常用）的类似概念，诸如：“绿色线程”、“纤程”等，在这里简单提一下吧。首先比如说“绿色线程”，它是由语言运行平台进行调度的，与由操作系统直接进行调度的线程的概念相对，譬如 Java 的 JVM。而“纤程”貌似和“协程”的意思差别不大，是微软搞的一个东西。

## Golang 中关于并发的一些语法

### WaitGroup

在 fjj 的 wp 有看到一个 `sync.WaitGroup` 的东西，之前课上貌似没讲过，于是查了下用法，然后写了个小程序测试了一下：

```go
var wg sync.WaitGroup
wg.Add(48)
for i := 0; i < 48; i++ {
	go func() {
		a := 1
		for {
			a++
		}
	}()
}
wg.Wait()
```

![](2.png)

嗯，果然不出所料，CPU 直接满载。另外说个题外话，我之前也用 Javascript 的 Worker 写过一个通过多线程让 CPU 满载的[小程序](https://github.com/lomirus/chaos)来着，结果没想到第一次练习 WaitGroup 也搞了个异曲同工的东西。~~着实恶趣味~~

![小丑竟是我自己](clownismyself.jpg)


## 求完美数算法的实现

如无特殊说明，以下代码运行的硬件环境均为 Legion R7000 (AMD Ryzen 5 4600H) ，且已开启性能模式，软件环境为 Windows 10 x64 20H2, Go 1.15；

且为了使比较 CPU 利用率时更加明显，当截取 CPU 利用率的图片时将会把所求完美数的范围尽量放大，比如改为 2~10000000。

### 完美数定义

> 完全数（Perfect number），又称完美数或完备数，是一些特殊的自然数：它所有的真因子（即除了自身以外的约数）的和，恰好等于它本身，完全数不可能是楔形数、平方数、佩尔数或费波那契数。
>
>例如：第一个完全数是6，它有约数1、2、3、6，除去它本身6外，其余3个数相加， `$$1+2+3=6` ，恰好等于本身。第二个完全数是28，它有约数1、2、4、7、14、28，除去它本身28外，其余5个数相加，` $$1+2+4+7+14=28` ，也恰好等于本身。后面的数是496、8128。`$$^{[6]}`

### 暴力遍历

一开始先上个最简单的吧。~~结果导致我被 xxj 给批了一顿（悲~~

![](iamlj.jpg)

```go
const n = 123456
for i := 2; i < n; i++ {
	var factors = []int{1}
	for j := 2; j < int(math.Sqrt(float64(i)))+1; j++ {
		if i%j == 0 {
			factors = append(factors, j)
			if j*j != i {
				factors = append(factors, i/j)
			}
		}
	}
	var sum = 0
	for j := range factors {
		sum += factors[j]
	}
	if sum == i {
		fmt.Println(i)
	}
}

```

``` 
Repeat: 32
Sum: 5089ms
Avg: 159ms
```

![](1.png)

### 利用 goroutine 进行初步优化

### blablabla

~~盲目并行不可取，特别是对我这种单核单线程的人类生物来说，所以待我先解决完最近几门期末考试再补这个~~

### 阿巴阿巴

## 参考资料


* [1] [中央处理器 - 维基百科](https://zh.wikipedia.org/zh/%E4%B8%AD%E5%A4%AE%E5%A4%84%E7%90%86%E5%99%A8)
* [2] [CPU的核心数和线程数量是什么关系？ - 老号被知乎永封 - 知乎](https://www.zhihu.com/question/274189552)
* [3] [进程 - 维基百科](https://zh.wikipedia.org/wiki/%E8%A1%8C%E7%A8%8B)
* [4] [线程 - 维基百科](https://zh.wikipedia.org/wiki/%E7%BA%BF%E7%A8%8B)
* [5] [后端第三节课 - 2020 红岩课件 - 语雀](https://www.yuque.com/cxyuts/gyq5k1/mmsi2x)
* [6] [完全数 - 维基百科](https://zh.wikipedia.org/wiki/%E5%AE%8C%E5%85%A8%E6%95%B0)